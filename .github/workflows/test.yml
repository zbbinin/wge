name: test Workflow

on:
  workflow_call:
    # inputs:
    #   matrix-os:
    #     required: true
    #     type: string
    # secrets:
    #   GITHUB_TOKEN:
    #     required: true
  workflow_dispatch:  # 允许手动触发



jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      ACTIONS_RUNNER_DEBUG: true  
    container:
      image: ghcr.io/${{ github.repository }}/wge-build:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      #如果镜像存在相同项目 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: debug cache
        run: |
          echo "::group::Debug cache information"
          ls  -lh ./
          #ls -tlh ./build/release/vcpkg_installed/
          du -sh /opt/vcpkg 
          whoami
          echo "Current directory: $(pwd)"
          echo "Home directory: $HOME"
          git config --global --add safe.directory /__w/wge/wge
          mkdir -p $HOME/.cache/
          ln -s /root/.cache/vcpkg $HOME/.cache/vcpkg
          du -sh ~/.cache/vcpkg/
          du -sh /root/.cache/vcpkg/
          echo "::endgroup::"
          
      - name: Update submodule
        run: |
          echo "::group::Updating submodules"
          git submodule update --init
          echo "::endgroup::"

      - name: Install ANTLR4
        run: |
          echo "::group::Install ANTLR4"
          source /etc/profile || true
          antlr4 || true
          export
          cat /etc/profile
          echo "ANTLR4 installation completed."
          echo "::endgroup::"

      - name: Configure CMake
        run: |
          echo "::group::Configuring CMake"
          export VCPKG_ROOT="/opt/vcpkg"
          export VCPKG_DEFAULT_TRIPLET=x64-linux
          cmake --preset=release
          echo "Environment variables:"
          env
          echo "::endgroup::"

      - name: Build
        run: |
          echo "::group::Building project"
          cmake --build build/release -t wge test --verbose
          echo "::endgroup::"

      - name: Run tests
        run: |
          echo "::group::Running tests"
          ./build/release/test/test
          echo "::endgroup::"

      - name: Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build/release/CMakeFiles/CMakeOutput.log
            build/release/CMakeFiles/CMakeError.log
            build/release/Testing/Temporary/LastTest.log
          retention-days: 7
      
      # # Run tests
      # - name: Run tests
      #   working-directory: ${{github.workspace}}
      #   run: |
      #     echo "::group::Running tests"
      #     set -e
      #     ./build/release/test/test || (echo "Tests failed. Check logs for details." && exit 1)
      #     echo  ANTLR4_JAR_CACHE: $ANTLR4_JAR_CACHE
      #     ls $ANTLR4_JAR_CACHE -tlh
      #     echo "::endgroup::"
  
      # # Run benchmarks
      # - name: Run benchmarks
      #   working-directory: ${{github.workspace}}
      #   run: |
      #     set -e
      #     echo "::group::Running benchmarks"
      #     ./build/release/benchmark/benchmark || (echo "Benchmarks failed. Check logs for details." && exit 1)
          
      # 发布版本 打印benchmarks测试结果
      # - name: Create Release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   with:
      #     tag_name: ${{ github.ref_name }}
      #     release_name: Release ${{ github.ref_name }}
      #     draft: false
      #     prerelease: false
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     body: |
      #       Benchmark results available in workflow artifacts